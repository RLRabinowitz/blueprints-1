version: 1
deploy:
  steps:
    setupVariables:
      after:
        - curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
        - chmod 755 ./opa
        - ./opa version
    terraformPlan:
      after:
        - terraform show -json .tf-plan > tfplan.json
        - ./opa eval --format pretty --data ./tf-lib.rego --data ./validation.rego --input tfplan.json "data.terraform.validation.deny"

